<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Gestione efficiente dei dati ISTAT • istatlab</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Gestione efficiente dei dati ISTAT">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">istatlab</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.7.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/getting-started.html">Get Started</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><h6 class="dropdown-header" data-toc-skip>English</h6></li>
    <li><a class="dropdown-item" href="../articles/getting-started.html">Getting Started</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Italiano</h6></li>
    <li><a class="dropdown-item" href="../articles/getting-started-it.html">Introduzione a istatlab</a></li>
    <li><a class="dropdown-item" href="../articles/api-istat-sdmx-it.html">API ISTAT SDMX: guida completa</a></li>
    <li><a class="dropdown-item" href="../articles/gestione-dati-it.html">Gestione efficiente dei dati</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/gmontaletti/istatlab" aria-label="GitHub"><span class="fa fab fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Gestione efficiente dei dati ISTAT</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/gmontaletti/istatlab/blob/main/vignettes/gestione-dati-it.Rmd" class="external-link"><code>vignettes/gestione-dati-it.Rmd</code></a></small>
      <div class="d-none name"><code>gestione-dati-it.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://gmontaletti.github.io/istatlab/">istatlab</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="perché-minimizzare-le-chiamate-api">1. Perché minimizzare le chiamate API<a class="anchor" aria-label="anchor" href="#perch%C3%A9-minimizzare-le-chiamate-api"></a>
</h2>
<p>L’API SDMX di ISTAT ha limiti di velocità e timeout di connessione
(il valore predefinito del pacchetto è 240 secondi). Il download di
dataset di grandi dimensioni richiede tempo e può comportare errori di
rete. La memorizzazione nella cache dei dati garantisce riproducibilità:
i risultati rimangono coerenti anche se ISTAT aggiorna i dataset. Il
pacchetto istatlab è progettato per minimizzare le chiamate API
ridondanti attraverso un sistema di cache a più livelli.</p>
<p>Le chiamate API ripetute causano:</p>
<ul>
<li>Timeout di connessione su dataset voluminosi</li>
<li>Sovraccarico dei server ISTAT</li>
<li>Tempi di attesa prolungati per l’utente</li>
<li>Risultati potenzialmente incoerenti tra esecuzioni successive</li>
</ul>
<p>Il sistema di cache riduce questi problemi mantenendo metadati e dati
scaricati in locale.</p>
</div>
<div class="section level2">
<h2 id="limiti-e-blocchi-dellapi-istat">2. Limiti e blocchi dell’API ISTAT<a class="anchor" aria-label="anchor" href="#limiti-e-blocchi-dellapi-istat"></a>
</h2>
<p>L’API SDMX di ISTAT applica limiti di velocità per proteggere
l’infrastruttura del server. Il superamento di questi limiti può
comportare blocchi temporanei degli indirizzi IP. Il pacchetto istatlab
implementa contromisure automatiche per rispettare questi limiti e
gestire gli errori di rete.</p>
<div class="section level3">
<h3 id="comportamento-del-rate-limiting">2.1 Comportamento del rate limiting<a class="anchor" aria-label="anchor" href="#comportamento-del-rate-limiting"></a>
</h3>
<p>ISTAT impone un limite di circa 5 richieste al minuto. Quando questo
limite viene superato, il server risponde con HTTP 429 (Too Many
Requests). Dopo violazioni ripetute, il server può bloccare
temporaneamente l’indirizzo IP per 24-48 ore.</p>
<p>Il server può anche restituire HTTP 503 (Service Unavailable) quando
è sovraccarico o durante manutenzioni.</p>
</div>
<div class="section level3">
<h3 id="sistema-di-throttling">2.2 Sistema di throttling<a class="anchor" aria-label="anchor" href="#sistema-di-throttling"></a>
</h3>
<p>La funzione <code><a href="../reference/throttle.html">throttle()</a></code> in
<code>R/http_transport.R</code> applica un ritardo minimo di 13 secondi
tra le richieste consecutive. Questo corrisponde a circa 4.6 richieste
al minuto, valore inferiore al limite di circa 5 richieste al minuto
imposto da ISTAT.</p>
<p>Il throttling utilizza un ambiente a livello di pacchetto
(<code>.istat_rate_limiter</code>) per tracciare il timestamp
dell’ultima richiesta. Ad ogni ritardo viene aggiunto un jitter casuale
(+/- 10%) per evitare pattern di richieste sincronizzate.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. Visualizzare la configurazione del rate limiting -----</span></span>
<span><span class="va">config</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_istat_config.html">get_istat_config</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">config</span><span class="op">$</span><span class="va">rate_limit</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. Il ritardo è applicato automaticamente tra chiamate -----</span></span>
<span><span class="co"># Non è necessaria alcuna azione da parte dell'utente</span></span>
<span><span class="va">data1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_istat_data.html">download_istat_data</a></span><span class="op">(</span><span class="st">"150_908"</span>, start_time <span class="op">=</span> <span class="st">"2023"</span><span class="op">)</span></span>
<span><span class="va">data2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_istat_data.html">download_istat_data</a></span><span class="op">(</span><span class="st">"534_50"</span>, start_time <span class="op">=</span> <span class="st">"2023"</span><span class="op">)</span></span>
<span><span class="co"># Il sistema attende automaticamente 13 secondi (+/- jitter) tra le due chiamate</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="retry-con-backoff-esponenziale">2.3 Retry con backoff esponenziale<a class="anchor" aria-label="anchor" href="#retry-con-backoff-esponenziale"></a>
</h3>
<p>La funzione <code><a href="../reference/http_get_with_retry.html">http_get_with_retry()</a></code> gestisce
automaticamente i codici HTTP 429 e 503 con tentativi di retry. Vengono
effettuati fino a 3 tentativi con backoff esponenziale:</p>
<ul>
<li>Primo retry: 60 secondi di attesa</li>
<li>Secondo retry: 120 secondi di attesa</li>
<li>Terzo retry: 240 secondi di attesa</li>
</ul>
<p>Il backoff massimo è limitato a 300 secondi. Se il server fornisce
l’header <code>Retry-After</code>, il sistema lo rispetta. Ad ogni
backoff viene aggiunto jitter casuale per evitare sincronizzazione.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. I retry sono gestiti automaticamente dal sistema -----</span></span>
<span><span class="co"># L'utente non deve implementare logica di retry manuale</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_istat_data.html">download_istat_data</a></span><span class="op">(</span><span class="st">"150_908"</span>, start_time <span class="op">=</span> <span class="st">"2020"</span><span class="op">)</span></span>
<span><span class="co"># In caso di 429 o 503, il sistema ritenta fino a 3 volte</span></span>
<span></span>
<span><span class="co"># 2. Parametri di configurazione del backoff -----</span></span>
<span><span class="va">config</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_istat_config.html">get_istat_config</a></span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">rate_limit</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Max retries:"</span>, <span class="va">config</span><span class="op">$</span><span class="va">max_retries</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Initial backoff:"</span>, <span class="va">config</span><span class="op">$</span><span class="va">initial_backoff</span>, <span class="st">"secondi"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Backoff multiplier:"</span>, <span class="va">config</span><span class="op">$</span><span class="va">backoff_multiplier</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Max backoff:"</span>, <span class="va">config</span><span class="op">$</span><span class="va">max_backoff</span>, <span class="st">"secondi"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="rilevamento-del-ban">2.4 Rilevamento del ban<a class="anchor" aria-label="anchor" href="#rilevamento-del-ban"></a>
</h3>
<p>La funzione <code><a href="../reference/detect_ban.html">detect_ban()</a></code> monitora le risposte HTTP 429
consecutive. Dopo 3 risposte 429 consecutive (threshold configurabile),
il sistema emette un warning che indica un probabile ban dell’indirizzo
IP e interrompe i tentativi di retry.</p>
<p>Dopo un periodo di attesa di 24-48 ore, è possibile resettare lo
stato del rate limiter con <code><a href="../reference/reset_rate_limiter.html">reset_rate_limiter()</a></code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. Il rilevamento del ban è automatico -----</span></span>
<span><span class="co"># Il sistema emette un warning dopo 3 risposte 429 consecutive</span></span>
<span><span class="co"># Warning: "Your IP may be temporarily banned by ISTAT. Wait 24-48 hours."</span></span>
<span></span>
<span><span class="co"># 2. Reset del rate limiter dopo il periodo di ban -----</span></span>
<span><span class="fu"><a href="../reference/reset_rate_limiter.html">reset_rate_limiter</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># Resetta il contatore di 429 consecutivi e il timestamp dell'ultima richiesta</span></span>
<span></span>
<span><span class="co"># 3. Configurazione della soglia di rilevamento -----</span></span>
<span><span class="va">config</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_istat_config.html">get_istat_config</a></span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">rate_limit</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Ban detection threshold:"</span>, <span class="va">config</span><span class="op">$</span><span class="va">ban_detection_threshold</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="esecuzione-sequenziale-nei-download-multipli">2.5 Esecuzione sequenziale nei download multipli<a class="anchor" aria-label="anchor" href="#esecuzione-sequenziale-nei-download-multipli"></a>
</h3>
<p>La funzione <code><a href="../reference/download_multiple_datasets.html">download_multiple_datasets()</a></code> forza
l’esecuzione sequenziale dei download per garantire che il rate limiting
sia rispettato. Il parametro <code>n_cores</code> è mantenuto per
compatibilità con versioni precedenti, ma viene ignorato.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. Download di dataset multipli con rate limiting -----</span></span>
<span><span class="va">dataset_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"150_908"</span>, <span class="st">"534_50"</span>, <span class="st">"534_51"</span><span class="op">)</span></span>
<span><span class="va">data_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_multiple_datasets.html">download_multiple_datasets</a></span><span class="op">(</span><span class="va">dataset_ids</span>, start_time <span class="op">=</span> <span class="st">"2020"</span><span class="op">)</span></span>
<span><span class="co"># I download avvengono in sequenza con throttling applicato</span></span>
<span></span>
<span><span class="co"># 2. Il parametro n_cores è ignorato -----</span></span>
<span><span class="co"># Mantenuto per retrocompatibilità, ma l'esecuzione è sempre sequenziale</span></span>
<span><span class="va">data_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_multiple_datasets.html">download_multiple_datasets</a></span><span class="op">(</span><span class="va">dataset_ids</span>, n_cores <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co"># n_cores viene ignorato: esecuzione sequenziale con rate limiting</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="fallback-del-trasporto-http">2.6 Fallback del trasporto HTTP<a class="anchor" aria-label="anchor" href="#fallback-del-trasporto-http"></a>
</h3>
<p>La funzione <code><a href="../reference/http_get.html">http_get()</a></code> tenta prima di utilizzare
<code><a href="https://httr.r-lib.org/reference/GET.html" class="external-link">httr::GET()</a></code>. Se fallisce, il sistema utilizza
automaticamente curl di sistema come fallback. Questo fornisce
resilienza contro problemi specifici delle librerie HTTP.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. Il fallback è completamente trasparente -----</span></span>
<span><span class="co"># L'utente non deve gestire manualmente il metodo HTTP</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_istat_data.html">download_istat_data</a></span><span class="op">(</span><span class="st">"150_908"</span>, start_time <span class="op">=</span> <span class="st">"2023"</span><span class="op">)</span></span>
<span><span class="co"># Il sistema seleziona automaticamente il metodo HTTP appropriato</span></span>
<span></span>
<span><span class="co"># 2. Il risultato include il metodo utilizzato -----</span></span>
<span><span class="co"># Disponibile nei log interni per debugging</span></span>
<span><span class="co"># Method: "httr" o "curl"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="classificazione-degli-errori">2.7 Classificazione degli errori<a class="anchor" aria-label="anchor" href="#classificazione-degli-errori"></a>
</h3>
<p>Il sistema classifica gli errori API con exit code standardizzati
(definiti in <code>R/error_handling.R</code>):</p>
<ul>
<li>
<strong>Exit code 0</strong>: Operazione riuscita</li>
<li>
<strong>Exit code 1</strong>: Errore generico (connettività, HTTP,
parsing)</li>
<li>
<strong>Exit code 2</strong>: Timeout di connessione</li>
<li>
<strong>Exit code 3</strong>: Rate limiting (HTTP 429)</li>
</ul>
<p>La funzione <code><a href="../reference/classify_api_error.html">classify_api_error()</a></code> categorizza gli errori
per una gestione coerente:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. Gli exit code sono gestiti internamente -----</span></span>
<span><span class="co"># L'utente riceve messaggi di errore descrittivi</span></span>
<span><span class="co"># Gli exit code sono disponibili negli oggetti istat_result</span></span>
<span></span>
<span><span class="co"># 2. Verifica manuale dello stato (avanzato) -----</span></span>
<span><span class="co"># La maggior parte degli utenti non necessita di questo livello di dettaglio</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/download_istat_data.html">download_istat_data</a></span><span class="op">(</span><span class="st">"INVALID_ID"</span><span class="op">)</span>,</span>
<span>  error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Il sistema classifica automaticamente il tipo di errore</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="il-sistema-di-cache-dei-metadati">3. Il sistema di cache dei metadati<a class="anchor" aria-label="anchor" href="#il-sistema-di-cache-dei-metadati"></a>
</h2>
<p>La funzione <code><a href="../reference/download_metadata.html">download_metadata()</a></code> scarica il catalogo
completo dei dataset ISTAT e lo memorizza in
<code>meta/flussi_istat.rds</code> con un TTL (time-to-live) di 14
giorni. Alla prima chiamata, i dati vengono scaricati dall’API. Le
chiamate successive leggono dalla cache locale fino alla scadenza.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. Primo download: interroga l'API ISTAT -----</span></span>
<span><span class="va">metadata</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_metadata.html">download_metadata</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># Scarica il catalogo e lo salva in meta/flussi_istat.rds</span></span>
<span></span>
<span><span class="co"># 2. Chiamate successive: legge dalla cache -----</span></span>
<span><span class="va">metadata</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_metadata.html">download_metadata</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># Restituisce i dati dalla cache senza chiamare l'API</span></span></code></pre></div>
<p>Struttura della directory cache:</p>
<pre><code><span><span class="va">meta</span><span class="op">/</span></span>
<span>  <span class="va">flussi_istat.rds</span>          <span class="co"># Catalogo dei dataset</span></span>
<span>  <span class="va">codelists.rds</span>             <span class="co"># Codelist memorizzate nella cache</span></span>
<span>  <span class="va">dataset_codelist_map.rds</span>  <span class="co"># Mapping dataset-codelist</span></span>
<span>  <span class="va">data_download_log.rds</span>     <span class="co"># Registro timestamp download</span></span>
<span>  <span class="va">codelist_metadata.rds</span>     <span class="co"># Metadati TTL codelist</span></span></code></pre>
<p>Per visualizzare la configurazione della cache:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. Configurazione generale -----</span></span>
<span><span class="va">config</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_istat_config.html">get_istat_config</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">config</span><span class="op">$</span><span class="va">cache</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. Durata predefinita della cache -----</span></span>
<span><span class="va">cache_days</span> <span class="op">&lt;-</span> <span class="va">config</span><span class="op">$</span><span class="va">defaults</span><span class="op">$</span><span class="va">cache_days</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Cache TTL:"</span>, <span class="va">cache_days</span>, <span class="st">"giorni"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="il-sistema-ttl-sfalsato-per-le-codelist">4. Il sistema TTL sfalsato per le codelist<a class="anchor" aria-label="anchor" href="#il-sistema-ttl-sfalsato-per-le-codelist"></a>
</h2>
<p>Le codelist (classificazioni come ITTER107 per i territori o ATECO
per le attività economiche) sono memorizzate separatamente. Se tutte le
codelist scadessero simultaneamente, si verificherebbe un sovraccarico
dell’API. Il pacchetto utilizza un sistema di TTL sfalsato: ogni
codelist ha una durata calcolata come
<code>base_ttl + hash(codelist_id) % jitter_days</code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. Calcolare il TTL di una codelist specifica -----</span></span>
<span><span class="va">ttl_days</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_codelist_ttl.html">compute_codelist_ttl</a></span><span class="op">(</span><span class="st">"CL_ITTER107"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"TTL per CL_ITTER107:"</span>, <span class="va">ttl_days</span>, <span class="st">"giorni"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. Verificare quali codelist sono scadute per un dataset -----</span></span>
<span><span class="va">expired_info</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/check_codelist_expiration.html">check_codelist_expiration</a></span><span class="op">(</span><span class="st">"150_908"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">expired_info</span><span class="op">$</span><span class="va">expired_codelists</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. Aggiornare solo le codelist scadute -----</span></span>
<span><span class="fu"><a href="../reference/refresh_expired_codelists.html">refresh_expired_codelists</a></span><span class="op">(</span><span class="st">"150_908"</span><span class="op">)</span></span></code></pre></div>
<p>Configurazione del sistema TTL:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. Visualizzare i parametri TTL -----</span></span>
<span><span class="va">config</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_istat_config.html">get_istat_config</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">base_ttl</span> <span class="op">&lt;-</span> <span class="va">config</span><span class="op">$</span><span class="va">cache</span><span class="op">$</span><span class="va">codelist_base_ttl_days</span>  <span class="co"># 14 giorni</span></span>
<span><span class="va">jitter</span> <span class="op">&lt;-</span> <span class="va">config</span><span class="op">$</span><span class="va">cache</span><span class="op">$</span><span class="va">codelist_jitter_days</span>      <span class="co"># 14 giorni</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Base TTL:"</span>, <span class="va">base_ttl</span>, <span class="st">"| Jitter:"</span>, <span class="va">jitter</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. Funzioni di gestione metadati (basso livello) -----</span></span>
<span><span class="va">metadata</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_codelist_metadata.html">load_codelist_metadata</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># save_codelist_metadata(metadata)  # Salvataggio manuale</span></span></code></pre></div>
<p>Questo approccio distribuisce i refresh delle codelist nel tempo,
evitando picchi di carico sull’API.</p>
</div>
<div class="section level2">
<h2 id="verificare-gli-aggiornamenti-prima-del-download">5. Verificare gli aggiornamenti prima del download<a class="anchor" aria-label="anchor" href="#verificare-gli-aggiornamenti-prima-del-download"></a>
</h2>
<p>Prima di scaricare un dataset, è possibile verificare se ISTAT ha
pubblicato aggiornamenti dall’ultimo download. La funzione
<code><a href="../reference/get_dataset_last_update.html">get_dataset_last_update()</a></code> restituisce il timestamp
<code>LAST_UPDATE</code> fornito dall’API. Il parametro
<code>check_update = TRUE</code> confronta questo timestamp con il
registro dei download locali.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. Verificare manualmente il timestamp di aggiornamento -----</span></span>
<span><span class="va">last_update</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_dataset_last_update.html">get_dataset_last_update</a></span><span class="op">(</span><span class="st">"150_908"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">last_update</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. Download con verifica automatica -----</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_istat_data.html">download_istat_data</a></span><span class="op">(</span><span class="st">"150_908"</span>, start_time <span class="op">=</span> <span class="st">"2023"</span>, check_update <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># Se i dati non sono cambiati, restituisce NULL con messaggio informativo</span></span></code></pre></div>
<p>Workflow completo:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. Prima esecuzione: scarica e registra il timestamp -----</span></span>
<span><span class="va">data_iniziale</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_istat_data.html">download_istat_data</a></span><span class="op">(</span><span class="st">"150_908"</span>,</span>
<span>                                      start_time <span class="op">=</span> <span class="st">"2023"</span>,</span>
<span>                                      check_update <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">data_iniziale</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. Esecuzione successiva: verifica prima di scaricare -----</span></span>
<span><span class="va">data_aggiornata</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_istat_data.html">download_istat_data</a></span><span class="op">(</span><span class="st">"150_908"</span>,</span>
<span>                                        start_time <span class="op">=</span> <span class="st">"2023"</span>,</span>
<span>                                        check_update <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># Se LAST_UPDATE non è cambiato, restituisce NULL</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">data_aggiornata</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">"Nessun aggiornamento disponibile, utilizzo dati esistenti"</span><span class="op">)</span></span>
<span>  <span class="va">data_aggiornata</span> <span class="op">&lt;-</span> <span class="va">data_iniziale</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Questo meccanismo riduce drasticamente le chiamate API non
necessarie.</p>
</div>
<div class="section level2">
<h2 id="download-incrementale-per-periodo-temporale">6. Download incrementale per periodo temporale<a class="anchor" aria-label="anchor" href="#download-incrementale-per-periodo-temporale"></a>
</h2>
<p>Il parametro <code>incremental</code> consente di scaricare solo i
dati da una data specifica in poi. Accetta oggetti Date o stringhe di
carattere nei formati “YYYY”, “YYYY-MM”, “YYYY-MM-DD”. Questo è utile
per aggiornamenti periodici che necessitano solo dei dati più
recenti.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. Download incrementale con anno -----</span></span>
<span><span class="va">data_2024</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_istat_data.html">download_istat_data</a></span><span class="op">(</span><span class="st">"150_908"</span>, incremental <span class="op">=</span> <span class="st">"2024"</span><span class="op">)</span></span>
<span><span class="co"># Scarica solo i dati dal 2024 in poi</span></span>
<span></span>
<span><span class="co"># 2. Download incrementale con data specifica -----</span></span>
<span><span class="va">data_recenti</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_istat_data.html">download_istat_data</a></span><span class="op">(</span><span class="st">"150_908"</span>,</span>
<span>                                     incremental <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2024-06-01"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Scarica dati da giugno 2024 in poi</span></span>
<span></span>
<span><span class="co"># 3. Differenza tra incremental e start_time -----</span></span>
<span><span class="co"># incremental ha precedenza su start_time</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_istat_data.html">download_istat_data</a></span><span class="op">(</span><span class="st">"150_908"</span>,</span>
<span>                             start_time <span class="op">=</span> <span class="st">"2020"</span>,</span>
<span>                             incremental <span class="op">=</span> <span class="st">"2024"</span><span class="op">)</span></span>
<span><span class="co"># Scarica solo dal 2024, start_time viene ignorato</span></span></code></pre></div>
<p>Caso d’uso tipico per job di aggiornamento regolare:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. Script di aggiornamento mensile -----</span></span>
<span><span class="va">anno_corrente</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.Date</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"%Y"</span><span class="op">)</span></span>
<span><span class="va">data_nuovi</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_istat_data.html">download_istat_data</a></span><span class="op">(</span><span class="st">"150_908"</span>, incremental <span class="op">=</span> <span class="va">anno_corrente</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. Combinazione con check_update -----</span></span>
<span><span class="va">data_nuovi</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_istat_data.html">download_istat_data</a></span><span class="op">(</span><span class="st">"150_908"</span>,</span>
<span>                                   incremental <span class="op">=</span> <span class="va">anno_corrente</span>,</span>
<span>                                   check_update <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># Scarica solo se ci sono aggiornamenti dal periodo specificato</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="integrazione-con-dati-esistenti">7. Integrazione con dati esistenti<a class="anchor" aria-label="anchor" href="#integrazione-con-dati-esistenti"></a>
</h2>
<p>Il parametro <code>existing_data</code> consente di integrare nuovi
download con dati già scaricati, gestendo automaticamente la
deduplicazione dei periodi sovrapposti. Questo è utile quando si
costruiscono serie storiche incrementali.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. Download iniziale di dati storici -----</span></span>
<span><span class="va">data_2023</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_istat_data.html">download_istat_data</a></span><span class="op">(</span><span class="st">"150_908"</span>,</span>
<span>                                  start_time <span class="op">=</span> <span class="st">"2023"</span>,</span>
<span>                                  end_time <span class="op">=</span> <span class="st">"2023"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">data_2023</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. Download aggiuntivo con integrazione -----</span></span>
<span><span class="va">data_completo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_istat_data.html">download_istat_data</a></span><span class="op">(</span><span class="st">"150_908"</span>,</span>
<span>                                      start_time <span class="op">=</span> <span class="st">"2024"</span>,</span>
<span>                                      existing_data <span class="op">=</span> <span class="va">data_2023</span><span class="op">)</span></span>
<span><span class="co"># data_completo contiene 2023 + 2024 senza duplicati</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">data_completo</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. Verifica della deduplicazione -----</span></span>
<span><span class="co"># La deduplicazione avviene sulle colonne chiave dimensionali</span></span>
<span><span class="co"># Mantiene le righe più recenti in caso di sovrapposizione</span></span></code></pre></div>
<p>Workflow per aggiornamenti periodici:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. Caricamento dati esistenti -----</span></span>
<span><span class="co"># data_storico &lt;- readRDS("data/serie_150_908.rds")</span></span>
<span></span>
<span><span class="co"># 2. Download incrementale e integrazione -----</span></span>
<span><span class="va">data_aggiornato</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_istat_data.html">download_istat_data</a></span><span class="op">(</span><span class="st">"150_908"</span>,</span>
<span>                                        incremental <span class="op">=</span> <span class="st">"2025"</span>,</span>
<span>                                        existing_data <span class="op">=</span> <span class="va">data_storico</span>,</span>
<span>                                        check_update <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. Salvataggio dati completi -----</span></span>
<span><span class="co"># saveRDS(data_aggiornato, "data/serie_150_908.rds")</span></span></code></pre></div>
<p>La logica di deduplicazione mantiene le righe più recenti quando
rileva duplicati sulle colonne chiave dimensionali.</p>
</div>
<div class="section level2">
<h2 id="download-in-batch-efficiente">8. Download in batch efficiente<a class="anchor" aria-label="anchor" href="#download-in-batch-efficiente"></a>
</h2>
<p>Per scaricare più dataset simultaneamente,
<code><a href="../reference/download_multiple_datasets.html">download_multiple_datasets()</a></code> utilizza l’esecuzione
parallela con <code><a href="https://rdrr.io/r/parallel/mclapply.html" class="external-link">parallel::mclapply()</a></code>. I core disponibili sono
configurabili.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. Download batch di dataset correlati -----</span></span>
<span><span class="va">dataset_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"534_50"</span>, <span class="st">"534_51"</span>, <span class="st">"534_52"</span><span class="op">)</span></span>
<span><span class="va">data_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_multiple_datasets.html">download_multiple_datasets</a></span><span class="op">(</span><span class="va">dataset_ids</span>,</span>
<span>                                         start_time <span class="op">=</span> <span class="st">"2020"</span><span class="op">)</span></span>
<span><span class="co"># Restituisce una lista nominata: data_list[["534_50"]], etc.</span></span>
<span></span>
<span><span class="co"># 2. Accesso ai dati scaricati -----</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">data_list</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">data_534_50</span> <span class="op">&lt;-</span> <span class="va">data_list</span><span class="op">[[</span><span class="st">"534_50"</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># 3. Download solo di dataset aggiornati -----</span></span>
<span><span class="va">timestamp_riferimento</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXct</a></span><span class="op">(</span><span class="st">"2025-12-10 14:30:00"</span>, tz <span class="op">=</span> <span class="st">"UTC"</span><span class="op">)</span></span>
<span><span class="va">updated_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_multiple_datasets.html">download_multiple_datasets</a></span><span class="op">(</span><span class="va">dataset_ids</span>,</span>
<span>                                            updated_after <span class="op">=</span> <span class="va">timestamp_riferimento</span><span class="op">)</span></span>
<span><span class="co"># Scarica solo i dataset modificati dopo il timestamp</span></span></code></pre></div>
<p>Gestione degli errori:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. Download batch con gestione errori -----</span></span>
<span><span class="va">dataset_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"150_908"</span>, <span class="st">"INVALID_ID"</span>, <span class="st">"534_50"</span><span class="op">)</span></span>
<span><span class="va">data_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_multiple_datasets.html">download_multiple_datasets</a></span><span class="op">(</span><span class="va">dataset_ids</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. Verifica dei risultati -----</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">id</span> <span class="kw">in</span> <span class="va">dataset_ids</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">data_list</span><span class="op">[[</span><span class="va">id</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Errore nel download di"</span>, <span class="va">id</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Scaricato"</span>, <span class="va">id</span>, <span class="st">":"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data_list</span><span class="op">[[</span><span class="va">id</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, <span class="st">"righe"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># I dataset con errori restituiscono NULL, gli altri continuano</span></span></code></pre></div>
<p>Il parallelismo accelera significativamente il download di più
dataset indipendenti.</p>
</div>
<div class="section level2">
<h2 id="frequenze-e-download-mirato">9. Frequenze e download mirato<a class="anchor" aria-label="anchor" href="#frequenze-e-download-mirato"></a>
</h2>
<p>I dataset ISTAT possono contenere dati con frequenze diverse
(annuale, trimestrale, mensile). La funzione
<code><a href="../reference/get_available_frequencies.html">get_available_frequencies()</a></code> identifica le frequenze
presenti. La funzione <code><a href="../reference/download_istat_data_by_freq.html">download_istat_data_by_freq()</a></code> può
scaricare automaticamente tutte le frequenze separatamente o filtrare
per una frequenza specifica.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. Identificare le frequenze disponibili -----</span></span>
<span><span class="va">freq_disponibili</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_available_frequencies.html">get_available_frequencies</a></span><span class="op">(</span><span class="st">"151_914"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">freq_disponibili</span><span class="op">)</span>  <span class="co"># es. c("A", "Q", "M")</span></span>
<span></span>
<span><span class="co"># 2. Download automatico con split per frequenza -----</span></span>
<span><span class="va">data_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_istat_data_by_freq.html">download_istat_data_by_freq</a></span><span class="op">(</span><span class="st">"151_914"</span>, start_time <span class="op">=</span> <span class="st">"2020"</span><span class="op">)</span></span>
<span><span class="co"># Restituisce lista nominata: data_list$Q, data_list$A, data_list$M</span></span>
<span></span>
<span><span class="co"># 3. Accesso ai dati per frequenza -----</span></span>
<span><span class="va">data_trimestrale</span> <span class="op">&lt;-</span> <span class="va">data_list</span><span class="op">$</span><span class="va">Q</span></span>
<span><span class="va">data_annuale</span> <span class="op">&lt;-</span> <span class="va">data_list</span><span class="op">$</span><span class="va">A</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">data_trimestrale</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 4. Download solo frequenza specifica -----</span></span>
<span><span class="va">data_solo_Q</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_istat_data_by_freq.html">download_istat_data_by_freq</a></span><span class="op">(</span><span class="st">"151_914"</span>,</span>
<span>                                            start_time <span class="op">=</span> <span class="st">"2020"</span>,</span>
<span>                                            freq <span class="op">=</span> <span class="st">"Q"</span><span class="op">)</span></span>
<span><span class="co"># Restituisce solo i dati trimestrali</span></span></code></pre></div>
<p>Considerazioni sull’efficienza:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. Quando usare freq parameter -----</span></span>
<span><span class="co"># Se serve solo una frequenza, specificare freq riduce i dati scaricati</span></span>
<span><span class="va">data_mensile</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_istat_data_by_freq.html">download_istat_data_by_freq</a></span><span class="op">(</span><span class="st">"151_914"</span>, freq <span class="op">=</span> <span class="st">"M"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. Quando usare split automatico -----</span></span>
<span><span class="co"># Se servono tutte le frequenze per analisi comparative</span></span>
<span><span class="va">data_tutte</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_istat_data_by_freq.html">download_istat_data_by_freq</a></span><span class="op">(</span><span class="st">"151_914"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. Alternativa con download_istat_data() -----</span></span>
<span><span class="co"># Per dataset con frequenza omogenea, usare download_istat_data()</span></span>
<span><span class="va">data_standard</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_istat_data.html">download_istat_data</a></span><span class="op">(</span><span class="st">"150_908"</span><span class="op">)</span></span>
<span><span class="co"># Più efficiente se non serve separazione per frequenza</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="gestione-della-directory-cache">10. Gestione della directory cache<a class="anchor" aria-label="anchor" href="#gestione-della-directory-cache"></a>
</h2>
<p>La directory cache predefinita è <code>meta/</code> nella directory
di lavoro corrente. È possibile specificare directory alternative con il
parametro <code>cache_dir</code>.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. Directory cache predefinita -----</span></span>
<span><span class="va">config</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_istat_config.html">get_istat_config</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">default_cache</span> <span class="op">&lt;-</span> <span class="va">config</span><span class="op">$</span><span class="va">cache</span><span class="op">$</span><span class="va">metadata_file</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">dirname</a></span><span class="op">(</span><span class="va">default_cache</span><span class="op">)</span><span class="op">)</span>  <span class="co"># "meta"</span></span>
<span></span>
<span><span class="co"># 2. Uso di directory cache alternativa -----</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_istat_data.html">download_istat_data</a></span><span class="op">(</span><span class="st">"150_908"</span>,</span>
<span>                             cache_dir <span class="op">=</span> <span class="st">"/percorso/alternativo/meta"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. Metadata con cache personalizzata -----</span></span>
<span><span class="va">metadata</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_metadata.html">download_metadata</a></span><span class="op">(</span>cache_dir <span class="op">=</span> <span class="st">"/percorso/alternativo/meta"</span><span class="op">)</span></span></code></pre></div>
<p>Portabilità e versionamento:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. Portabilità tra macchine -----</span></span>
<span><span class="co"># La directory meta/ può essere copiata tra sistemi</span></span>
<span><span class="co"># system("cp -r meta/ /altro/progetto/meta/")</span></span>
<span></span>
<span><span class="co"># 2. Controllo versione con git -----</span></span>
<span><span class="co"># Considerare .gitignore per file cache voluminosi</span></span>
<span><span class="co"># .gitignore:</span></span>
<span><span class="co">#   meta/*.rds</span></span>
<span><span class="co">#   !meta/flussi_istat.rds  # Tracciare solo metadata principale</span></span>
<span></span>
<span><span class="co"># 3. Pulizia cache per fresh start -----</span></span>
<span><span class="co"># unlink("meta", recursive = TRUE)</span></span>
<span><span class="co"># dir.create("meta")</span></span>
<span><span class="co"># Forza il re-download completo alla prossima chiamata</span></span></code></pre></div>
<p>Best practice:</p>
<ul>
<li>Mantenere la cache nella directory radice del progetto per
riproducibilità</li>
<li>Copiare <code>meta/</code> quando si condivide il progetto per
evitare re-download</li>
<li>Documentare la data di creazione della cache per tracciabilità</li>
<li>Usare <code>cache_dir</code> personalizzata solo per esigenze
specifiche di organizzazione</li>
</ul>
</div>
<div class="section level2">
<h2 id="riepilogo-e-best-practice">11. Riepilogo e best practice<a class="anchor" aria-label="anchor" href="#riepilogo-e-best-practice"></a>
</h2>
<p>Albero decisionale per la gestione dei download:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. Primo download di un dataset -----</span></span>
<span><span class="va">metadata</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_metadata.html">download_metadata</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_istat_data.html">download_istat_data</a></span><span class="op">(</span><span class="st">"150_908"</span>, start_time <span class="op">=</span> <span class="st">"2020"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. Aggiornamento periodico (job schedulato) -----</span></span>
<span><span class="va">data_aggiornato</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_istat_data.html">download_istat_data</a></span><span class="op">(</span><span class="st">"150_908"</span>,</span>
<span>                                        incremental <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.Date</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"%Y"</span><span class="op">)</span>,</span>
<span>                                        check_update <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. Integrazione con dati parziali esistenti -----</span></span>
<span><span class="va">data_completo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_istat_data.html">download_istat_data</a></span><span class="op">(</span><span class="st">"150_908"</span>,</span>
<span>                                      start_time <span class="op">=</span> <span class="st">"2025"</span>,</span>
<span>                                      existing_data <span class="op">=</span> <span class="va">data_storico</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 4. Download multipli correlati -----</span></span>
<span><span class="va">data_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_multiple_datasets.html">download_multiple_datasets</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"534_50"</span>, <span class="st">"534_51"</span>, <span class="st">"534_52"</span><span class="op">)</span>,</span>
<span>                                         start_time <span class="op">=</span> <span class="st">"2020"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 5. Download per frequenza specifica -----</span></span>
<span><span class="va">data_trimestrale</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_istat_data_by_freq.html">download_istat_data_by_freq</a></span><span class="op">(</span><span class="st">"151_914"</span>,</span>
<span>                                                  freq <span class="op">=</span> <span class="st">"Q"</span>,</span>
<span>                                                  start_time <span class="op">=</span> <span class="st">"2020"</span><span class="op">)</span></span></code></pre></div>
<p>Workflow consigliato per pipeline produttive:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. Setup iniziale del progetto -----</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="st">"data"</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="st">"meta"</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. Prima esecuzione: download completo -----</span></span>
<span><span class="va">metadata</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_metadata.html">download_metadata</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">data_iniziale</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_istat_data.html">download_istat_data</a></span><span class="op">(</span><span class="st">"150_908"</span>,</span>
<span>                                      start_time <span class="op">=</span> <span class="st">"2020"</span>,</span>
<span>                                      check_update <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">data_iniziale</span>, <span class="st">"data/dataset_150_908.rds"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. Aggiornamenti periodici (script schedulato) -----</span></span>
<span><span class="va">data_esistente</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"data/dataset_150_908.rds"</span><span class="op">)</span></span>
<span><span class="va">data_aggiornato</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_istat_data.html">download_istat_data</a></span><span class="op">(</span><span class="st">"150_908"</span>,</span>
<span>                                        incremental <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.Date</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"%Y"</span><span class="op">)</span>,</span>
<span>                                        existing_data <span class="op">=</span> <span class="va">data_esistente</span>,</span>
<span>                                        check_update <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">data_aggiornato</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">data_aggiornato</span>, <span class="st">"data/dataset_150_908.rds"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">"Dati aggiornati con successo"</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">"Nessun aggiornamento disponibile"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># 4. Verifica scadenza codelist -----</span></span>
<span><span class="fu"><a href="../reference/check_codelist_expiration.html">check_codelist_expiration</a></span><span class="op">(</span><span class="st">"150_908"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/refresh_expired_codelists.html">refresh_expired_codelists</a></span><span class="op">(</span><span class="st">"150_908"</span><span class="op">)</span></span></code></pre></div>
<p>Principi chiave:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Primo download</strong>: Usare
<code><a href="../reference/download_metadata.html">download_metadata()</a></code> e <code><a href="../reference/download_istat_data.html">download_istat_data()</a></code>
senza parametri complessi</li>
<li>
<strong>Aggiornamenti periodici</strong>: Combinare
<code>check_update = TRUE</code> con <code>incremental</code> per
efficienza</li>
<li>
<strong>Integrazione incrementale</strong>: Usare
<code>existing_data</code> per costruire serie storiche</li>
<li>
<strong>Batch processing</strong>: Preferire
<code><a href="../reference/download_multiple_datasets.html">download_multiple_datasets()</a></code> per dataset correlati</li>
<li>
<strong>Frequenze specifiche</strong>: Usare
<code>download_istat_data_by_freq(freq = "Q")</code> quando serve solo
una frequenza</li>
</ol>
<p>Riferimenti ad altre vignette:</p>
<ul>
<li>
<code><a href="../articles/getting-started-it.html">vignette("getting-started-it")</a></code>: Introduzione al
pacchetto e workflow base</li>
<li>
<code><a href="../articles/api-istat-sdmx-it.html">vignette("api-istat-sdmx-it")</a></code>: Dettagli tecnici
sull’API SDMX di ISTAT</li>
</ul>
<p>Per domande o problemi, consultare la documentazione delle funzioni
con <code><a href="../reference/download_istat_data.html">?download_istat_data</a></code> o
<code><a href="../reference/download_metadata.html">?download_metadata</a></code>.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Giampaolo Montaletti.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
